rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check for Admin role from the auth token's custom claims
    function isAdmin() {
      return request.auth.token.role == 'Admin';
    }

    // Rules for the 'users' collection
    match /users/{userId} {
      // Allow create by anyone (for new sign-ups)
      allow create: if true;

      // Allow read by the user themselves or by an admin
      allow read: if request.auth.uid == userId || isAdmin();
      
      // Allow update by the user, BUT NOT the 'role' or 'status' fields.
      // Those can only be changed by an admin.
      allow update: if request.auth.uid == userId 
                    && !('role' in request.resource.data)
                    && !('status' in request.resource.data);
      
      // Allow full write access (including role/status changes) only for Admins
      allow write: if isAdmin();
    }

    // Rules for 'posts' (Blog)
    match /posts/{postId} {
        // Anyone can read published posts
        allow read: if resource.data.status == 'Published';
        // Only admins can create, update, or delete posts
        allow write: if isAdmin();
    }
    
    // Rules for 'directory'
    match /directory/{businessId} {
        // Anyone can read approved businesses
        allow read: if resource.data.verificationStatus == 'approved';
        // Only admins can write to the directory
        allow write: if isAdmin();
    }
    
    // Subcollection for business-specific chat
    match /directory/{businessId}/businessChatSessions/{sessionId}/{document=**} {
        // Allow anyone to create chat sessions and messages
        allow create: if true;
        // Reading/updating should be restricted to the business owner or an admin.
        // This requires getting the owner UID from the parent directory document.
        allow read, update: if request.auth.uid == get(/databases/$(database)/documents/directory/$(businessId)).data.ownerUid || isAdmin();
    }

    // Rules for 'chatSessions' (Global Chat)
    match /chatSessions/{sessionId}/{document=**} {
      // Allow anyone to create chat sessions and messages
      allow create: if true;
      // Only admins can read/update global chat sessions
      allow read, update: if isAdmin();
    }
    
    // Config collections should only be accessible by admins
    match /agentConfig/{docId} {
      allow read, write: if isAdmin();
    }
    match /platformConfig/{docId} {
        allow read, write: if isAdmin();
    }

    // Rules for 'customers' and 'orders' (e-commerce)
    match /customers/{customerId} {
        // Only admins can manage customer data directly
        allow read, write: if isAdmin();
        // Allow users to create their own customer record during checkout
        allow create: if true; 
    }
    
    match /orders/{orderId} {
         // Only admins can manage orders directly
        allow read, write: if isAdmin();
         // Allow users to create their own orders during checkout
        allow create: if true;
    }

  }
}
